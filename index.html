<!DOCTYPE html>

<html lang="he" dir="rtl">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>×“×™×•×•×— ×ª×§×œ×•×ª - RSL</title>

    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {

            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            background: linear-gradient(to bottom right, #f0fdf4, #f0f9ff);

            padding: 20px; min-height: 100vh;

        }

        .container { max-width: 1400px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 30px; }

        .header h1 { font-size: 32px; color: #1f2937; margin-bottom: 10px; }

        .header p { color: #6b7280; font-size: 16px; }

 

        .section {

            background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);

            padding: 25px; margin-bottom: 20px;

        }

        .section h2 {

            font-size: 24px; color: #1f2937; margin-bottom: 20px;

            padding-bottom: 15px; border-bottom: 3px solid #8b5cf6;

            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;

        }

 

        .toolbar {

            display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 12px;

        }

        .input, .select, .btn {

            padding: 9px 12px; border-radius: 6px; border: 2px solid #d1d5db; font-size: 14px; font-family: inherit;

        }

        .input:focus, .select:focus { outline: none; border-color: #22c55e; }

        .btn { cursor: pointer; font-weight: 600; }

        .btn-primary { background: #a855f7; color: #fff; border-color: #a855f7; }

        .btn-primary:hover { background: #9333ea; border-color: #9333ea; }

        .btn-secondary { background: #3b82f6; color: #fff; border-color: #3b82f6; }

        .btn-secondary:hover { background: #2563eb; border-color: #2563eb; }

        .btn-outline { background: #fff; color: #374151; }

        .btn-outline:hover { background: #f3f4f6; }

 

        .equipment-grid {

            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));

            gap: 15px; margin-bottom: 15px;

        }

        .equipment-card {

            background: #faf5ff; border: 2px solid #d8b4fe; border-radius: 8px; padding: 15px;

        }

        .equipment-card-header {

            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;

        }

        .equipment-card ul { list-style: none; padding-right: 18px; }

        .equipment-card li { display: flex; align-items: center; gap: 8px; margin: 4px 0; flex-wrap: wrap; }

        .action-btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }

        .btn-edit { background: #f59e0b; color: white; }

        .btn-edit:hover { background: #d97706; }

        .btn-delete { background: #ef4444; color: white; }

        .btn-delete:hover { background: #dc2626; }

 

        .equipment-form {

            background: #faf5ff; padding: 15px; border-radius: 6px; border: 2px solid #d8b4fe;

            margin-top: 10px; max-width: 520px;

        }

        .equipment-form .hint { color: #6b7280; font-size: 12px; margin-top: -6px; margin-bottom: 8px; }

        .mode-badge {

            display:inline-block; background:#f59e0b; color:#fff; font-weight:700; font-size:12px;

            padding:2px 8px; border-radius:999px; margin-bottom:8px;

        }

        .form-grid {

            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

            gap: 15px; margin-bottom: 15px;

        }

        .form-grid-full { grid-column: 1 / -1; }

        .form-group { margin-bottom: 15px; }

        .form-group label {

            display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;

        }

        .form-group input, .form-group textarea, .form-group select {

            width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px;

            font-family: inherit; font-size: 14px;

        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {

            outline: none; border-color: #22c55e;

        }

        .btn-ok { background: #22c55e; color: white; border: none; }

        .btn-ok:hover { background: #16a34a; }

        .btn-cancel { background: #6b7280; color: white; border: none; }

        .btn-cancel:hover { background: #4b5563; }

 

        .btn-save {

            background: #22c55e; color: white; border: none; padding: 12px 20px;

            border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px;

        }

        .btn-save:hover { background: #16a34a; }

 

        .thumbs { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 0; }

        .thumbs img {

            width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;

        }

 

        .fault-item {

            border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fafafa;

        }

        .fault-item:hover { border-color: #22c55e; }

        .fault-grid {

            display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));

            gap: 10px; margin-bottom: 10px;

        }

        .fault-field { margin-bottom: 10px; }

        .fault-field strong { color: #1f2937; }

        .fault-field p { color: #4b5563; margin-top: 3px; }

        .fault-description {

            background: #f3f4f6; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 14px;

        }

        .fault-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }

        .fault-buttons button {

            flex: 1; min-width: 120px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;

        }

        .btn-rsl { background: #059669; color: white; }

        .btn-rsl:hover { background: #047857; }

        .btn-whatsapp { background: #22c55e; color: white; }

        .btn-whatsapp:hover { background: #16a34a; }

        .btn-copy { background: #3b82f6; color: white; }

        .btn-copy:hover { background: #2563eb; }

        .btn-edit-fault { background: #f59e0b; color: white; }

        .btn-edit-fault:hover { background: #d97706; }

 

        .edit-fault {

            background: #fff; border: 2px dashed #d1d5db; border-radius: 8px; padding: 12px; margin-top: 8px;

        }

 

        .empty-message { text-align: center; padding: 40px; color: #9ca3af; font-size: 16px; }

        .hidden { display: none; }

    </style>

</head>

<body>

<div class="container">

    <div class="header">

        <h1>ğŸ“± ×“×™×•×•×— ×ª×§×œ×•×ª</h1>

        <p>××¢×¨×›×ª ×“×™×•×•×— ×ª×§×œ×•×ª ×œ-WhatsApp ×¢× × ×™×”×•×œ ×¦×™×•×“</p>

    </div>

 

    <!-- Equipment Management -->

    <div class="section">

        <h2>âš™ï¸ × ×™×”×•×œ ×¦×™×•×“</h2>

 

        <div class="toolbar">

            <input id="equipmentSearch" class="input" type="text" placeholder="×—×™×¤×•×© ×¦×™×•×“/×ª×ª-×™×—×™×“×”..." oninput="renderEquipment()">

            <button class="btn btn-outline" onclick="clearEquipmentSearch()">× ×§×”</button>

            <button class="btn btn-primary" onclick="openCreateEquipmentForm()">â• ×”×•×¡×£ ×¦×™×•×“</button>

        </div>

 

        <div class="equipment-grid" id="equipmentGrid"></div>

 

        <div id="equipmentForm" class="equipment-form hidden" aria-live="polite">

            <div id="equipmentFormMode" class="mode-badge hidden">××¦×‘ ×¢×¨×™×›×”</div>

            <div class="form-group">

                <label>×©× ×”×¦×™×•×“ *</label>

                <input type="text" id="eqName" placeholder="×”×›× ×¡ ×©×">

                <div class="hint">××•××œ×¥ ×©× ×§×¦×¨ ×•×‘×¨×•×¨. ×œ×“×•×’××”: "××›×‘×© ××ª×™×—×” 1"</div>

            </div>

            <div class="form-group">

                <label>×¡×•×’ ×¦×™×•×“</label>

                <select id="eqType" onchange="updateParentOptions()">

                    <option value="parent">×¦×™×•×“ ××‘ (×¢× ×ª×ª-×™×—×™×“×•×ª)</option>

                    <option value="child">×¦×™×•×“ ×‘×Ÿ (×ª×ª-×™×—×™×“×”)</option>

                </select>

                <div class="hint" id="typeHint">×‘×—×¨ ×× ×–×” ×¦×™×•×“ ×¢×¦×××™ ××• ×ª×ª-×™×—×™×“×”</div>

            </div>

            <div class="form-group" id="parentSelect" style="display:none;">

                <label>×©×™×™×š ×œ- *</label>

                <select id="eqParent">

                    <option value="">-- ×‘×—×¨ ×¦×™×•×“ ××‘ --</option>

                </select>

            </div>

            <div class="form-grid">

                <button id="equipmentFormSubmit" class="btn-ok" onclick="saveEquipment()">×©××•×¨</button>

                <button class="btn-cancel" onclick="closeEquipmentForm()">×‘×˜×œ</button>

            </div>

        </div>

    </div>

 

    <!-- Report Form -->

    <div class="section">

        <h2>ğŸ“‹ ×˜×•×¤×¡ ×“×™×•×•×— ×ª×§×œ×”</h2>

        <div class="form-grid">

            <div class="form-group">

                <label>×‘×—×¨ ×¦×™×•×“ *</label>

                <select id="equipment">

                    <option value="">-- ×‘×—×¨ ×¦×™×•×“ --</option>

                </select>

            </div>

            <div class="form-group">

                <label>×©× ×”××“×•×•×— *</label>

                <input type="text" id="reporterName" placeholder="×”×›× ×¡ ×©×">

            </div>

            <div class="form-group">

                <label>×˜×›× ××™/×’×•×¨× ××‘×¦×¢ *</label>

                <input type="text" id="technician" placeholder="×”×›× ×¡ ×©×">

            </div>

            <div class="form-group">

                <label>×–××Ÿ ×”×ª×§×œ×”</label>

                <input type="datetime-local" id="faultTime">

            </div>

            <div class="form-group form-grid-full">

                <label>×ª×™××•×¨ ×”×ª×§×œ×”</label>

                <textarea id="description" rows="4" placeholder="×ª××¨ ××ª ×”×ª×§×œ×”..."></textarea>

            </div>

            <div class="form-group form-grid-full">

                <label>×ª××•× ×•×ª (×¢×“ 3 | ×¢×“ 1.5MB ×¡×”×´×›)</label>

                <input type="file" id="faultImages" accept="image/*" multiple>

            </div>

            <div class="form-group form-grid-full">

                <button class="btn-save" onclick="submitFault()">ğŸ’¾ ×©××•×¨ ×“×™×•×•×—</button>

            </div>

        </div>

    </div>

 

    <!-- Faults History -->

    <div class="section">

        <h2>

            ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×“×™×•×•×—×™×

            (<span id="faultCount">0</span>)

        </h2>

 

        <div class="toolbar">

            <input id="faultSearch" class="input" type="text" placeholder="×—×™×¤×•×©: ×¦×™×•×“ / ××“×•×•×— / ×˜×›× ××™ / ×ª×™××•×¨..." oninput="renderFaults()">

            <input id="faultFrom" class="input" type="date" title="××ª××¨×™×š" onchange="renderFaults()">

            <input id="faultTo" class="input" type="date" title="×¢×“ ×ª××¨×™×š" onchange="renderFaults()">

            <button class="btn btn-outline" onclick="clearFaultFilters()">× ×§×”</button>

            <div style="flex:1"></div>

            <button class="btn btn-secondary" onclick="exportFaultsCsv()">â¬‡ï¸ ×™×™×¦×•× CSV</button>

        </div>

 

        <div id="faultsList"></div>

    </div>

</div>

 

<script>

    // ===== Constants & Utilities =====

    const STORAGE_KEY = 'fr_rsl_state_v1';

    const MAX_IMAGES = 3;

    const MAX_IMAGES_TOTAL_BYTES = 1.5 * 1024 * 1024; // ~1.5MB

 

    // Escape user-input to avoid XSS when injecting via innerHTML

    function escapeHtml(str = '') {

        return String(str).replace(/[&<>"']/g, m => ({

            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'

        }[m]));

    }

 

    function toCsvValue(v) {

        const s = (v ?? '').toString().replace(/"/g, '""');

        return `"${s}"`;

    }

    function downloadBlob(content, filename, type) {

        const blob = new Blob([content], { type });

        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');

        a.href = url;

        a.download = filename;

        document.body.appendChild(a);

        a.click();

        setTimeout(() => {

            document.body.removeChild(a);

            URL.revokeObjectURL(url);

        }, 0);

    }

    function formatDateCompact(d = new Date()) {

        const pad = n => String(n).padStart(2, '0');

        return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;

    }

 

    // ===== Default data =====

    const defaultEquipment = [

        { id: 1, name: '×¡×§××¤ ×ª×¨××™×œ', isParent: true, children: [

                { id: 11, name: '××›×‘×© ××ª×™×—×” 1' },

                { id: 12, name: '××›×‘×© ××ª×™×—×” 2' },

                { id: 13, name: '××¢×¨×›×ª ×§×™×¨×•×¨' }

        ]},

        { id: 2, name: '×§×• ×™×™×¦×•×¨ B', isParent: true, children: [

                { id: 21, name: '×× ×•×¢ ×—×©××œ×™×ª' },

                { id: 22, name: '×“×•×¨ ××•×•×™×¨ ×“×—×•×¡' }

        ]},

        { id: 3, name: '××›×•× ×ª ×”×“×¤×¡×”', isParent: false, children: [] }

    ];

 

    // ===== State =====

    let equipment = [];

    let faults = [];

    let nextId = 100;

 

    // Equipment form state

    let eqFormMode = 'create'; // 'create' | 'edit'

    let editContext = null;    // { target: 'parent'|'child', parentId, childId? }

 

    // ===== Persistence =====

    function saveState() {

        const state = { equipment, faults, nextId };

        try {

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

        } catch (e) {

            console.warn('×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ×œ-localStorage', e);

        }

    }

 

    function loadState() {

        try {

            const raw = localStorage.getItem(STORAGE_KEY);

            if (raw) {

                const parsed = JSON.parse(raw);

                equipment = parsed.equipment || defaultEquipment.slice();

                faults = parsed.faults || [];

                nextId = typeof parsed.nextId === 'number' ? parsed.nextId : 100;

                return;

            }

        } catch (e) {

            console.warn('×©×’×™××” ×‘×˜×¢×™× ×ª ××¦×‘ ××”-localStorage', e);

        }

        equipment = defaultEquipment.slice();

        faults = [];

        nextId = 100;

    }

 

    // ===== Init =====

    document.addEventListener('DOMContentLoaded', () => {

        loadState();

        setDefaultDateTime();

        renderEquipment();

        renderFaults();

        updateEquipmentSelect();

    });

 

    function setDefaultDateTime() {

        const now = new Date();

        const year = now.getFullYear();

        const month = String(now.getMonth() + 1).padStart(2, '0');

        const day = String(now.getDate()).padStart(2, '0');

        const hours = String(now.getHours()).padStart(2, '0');

        const minutes = String(now.getMinutes()).padStart(2, '0');

        document.getElementById('faultTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;

    }

 

    // ===== Equipment Form Logic =====

    function openCreateEquipmentForm() {

        eqFormMode = 'create';

        editContext = null;

        const form = document.getElementById('equipmentForm');

        form.classList.remove('hidden');

 

        document.getElementById('equipmentFormMode').classList.add('hidden');

        document.getElementById('equipmentFormSubmit').textContent = '×©××•×¨';

 

        document.getElementById('eqName').value = '';

        document.getElementById('eqType').disabled = false;

        document.getElementById('eqType').value = 'parent';

        document.getElementById('typeHint').textContent = '×‘×—×¨ ×× ×–×” ×¦×™×•×“ ×¢×¦×××™ ××• ×ª×ª-×™×—×™×“×”';

        document.getElementById('parentSelect').style.display = 'none';

 

        refreshParentSelectOptions();

        document.getElementById('eqName').focus();

    }

 

    function openEditEquipment(parentId, childId) {

        eqFormMode = 'edit';

        const form = document.getElementById('equipmentForm');

        form.classList.remove('hidden');

        const badge = document.getElementById('equipmentFormMode');

        badge.classList.remove('hidden');

        badge.textContent = '××¦×‘ ×¢×¨×™×›×”';

        document.getElementById('equipmentFormSubmit').textContent = '×¢×“×›×Ÿ';

 

        refreshParentSelectOptions();

 

        if (childId == null) {

            // Edit parent

            const parent = equipment.find(e => e.id === parentId);

            if (!parent) return;

 

            editContext = { target: 'parent', parentId };

            document.getElementById('eqName').value = parent.name;

            document.getElementById('eqType').value = 'parent';

            document.getElementById('eqType').disabled = true;

            document.getElementById('parentSelect').style.display = 'none';

            document.getElementById('typeHint').textContent = '×¢×¨×™×›×ª ×©× ×¦×™×•×“ ××‘';

        } else {

            // Edit child

            const parent = equipment.find(e => e.id === parentId);

            if (!parent) return;

            const child = parent.children.find(c => c.id === childId);

            if (!child) return;

 

            editContext = { target: 'child', parentId, childId };

            document.getElementById('eqName').value = child.name;

            document.getElementById('eqType').value = 'child';

            document.getElementById('eqType').disabled = true;

            document.getElementById('parentSelect').style.display = 'block';

            document.getElementById('eqParent').value = String(parentId);

            document.getElementById('typeHint').textContent = '×¢×¨×™×›×ª ×©×/×©×™×•×š ×¦×™×•×“ ×‘×Ÿ';

        }

        document.getElementById('eqName').focus();

    }

 

    function closeEquipmentForm() {

        const form = document.getElementById('equipmentForm');

        form.classList.add('hidden');

        eqFormMode = 'create';

        editContext = null;

    }

 

    function updateParentOptions() {

        const type = document.getElementById('eqType').value;

        document.getElementById('parentSelect').style.display = type === 'child' ? 'block' : 'none';

    }

 

    function refreshParentSelectOptions() {

        const parentSelect = document.getElementById('eqParent');

        parentSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¦×™×•×“ ××‘ --</option>';

        equipment.filter(e => e.isParent).forEach(eq => {

            const opt = document.createElement('option');

            opt.value = String(eq.id);

            opt.textContent = eq.name;

            parentSelect.appendChild(opt);

        });

    }

 

    function saveEquipment() {

        const name = document.getElementById('eqName').value.trim();

        const type = document.getElementById('eqType').value;

        const parentIdStr = document.getElementById('eqParent').value;

        const parentId = parentIdStr ? parseInt(parentIdStr, 10) : null;

 

        if (!name) {

            alert('×”×›× ×¡ ×©× ×¦×™×•×“!');

            return;

        }

 

        if (eqFormMode === 'edit' && editContext) {

            if (editContext.target === 'parent') {

                const parent = equipment.find(e => e.id === editContext.parentId);

                if (!parent) return;

                parent.name = name;

            } else if (editContext.target === 'child') {

                const oldParent = equipment.find(e => e.id === editContext.parentId);

                if (!oldParent) return;

                const child = oldParent.children.find(c => c.id === editContext.childId);

                if (!child) return;

 

                if (!parentId) {

                    alert('×‘×—×¨ ×¦×™×•×“ ××‘!');

                    return;

                }

                // ×¢×“×›×•×Ÿ ×©×

                child.name = name;

 

                // ×©×™× ×•×™ ×”×•×¨×” (×× × ×“×¨×©)

                if (parentId !== editContext.parentId) {

                    oldParent.children = oldParent.children.filter(c => c.id !== child.id);

                    const newParent = equipment.find(e => e.id === parentId);

                    if (!newParent) {

                        alert('×¦×™×•×“ ×”××‘ ×©× ×‘×—×¨ ×œ× ×§×™×™×');

                        return;

                    }

                    newParent.children.push(child);

                    editContext.parentId = newParent.id;

                }

            }

 

            saveState();

            renderEquipment();

            updateEquipmentSelect();

            closeEquipmentForm();

            return;

        }

 

        // create mode

        if (type === 'child') {

            if (!parentId) {

                alert('×‘×—×¨ ×¦×™×•×“ ××‘!');

                return;

            }

            const parent = equipment.find(e => e.id === parentId);

            if (parent) {

                parent.children.push({ id: nextId++, name: name });

            }

        } else {

            equipment.push({ id: nextId++, name: name, isParent: true, children: [] });

        }

 

        saveState();

        renderEquipment();

        updateEquipmentSelect();

        closeEquipmentForm();

    }

 

    function deleteEquipment(parentId, childId) {

        if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§?')) return;

 

        if (childId) {

            const parent = equipment.find(e => e.id === parentId);

            if (parent) {

                parent.children = parent.children.filter(c => c.id !== childId);

            }

        } else {

            equipment = equipment.filter(e => e.id !== parentId);

        }

        saveState();

        renderEquipment();

        updateEquipmentSelect();

    }

 

    function clearEquipmentSearch() {

        document.getElementById('equipmentSearch').value = '';

        renderEquipment();

    }

 

    function renderEquipment() {

        const grid = document.getElementById('equipmentGrid');

        grid.innerHTML = '';

        const q = document.getElementById('equipmentSearch').value.trim().toLowerCase();

 

        equipment.forEach(eq => {

            const parentMatch = eq.name.toLowerCase().includes(q);

            const childMatches = (eq.children || []).filter(c => c.name.toLowerCase().includes(q));

 

            if (q && !parentMatch && childMatches.length === 0) {

                return; // ×œ× ××¦×™×’ ×›×¨×˜×™×¡ ×©×œ× ×ª×•××

            }

 

            const card = document.createElement('div');

            card.className = 'equipment-card';

 

            const header = document.createElement('div');

            header.className = 'equipment-card-header';

 

            const title = document.createElement('strong');

            title.textContent = eq.name;

            header.appendChild(title);

 

            const actions = document.createElement('div');

            const editBtn = document.createElement('button');

            editBtn.className = 'action-btn btn-edit';

            editBtn.textContent = 'âœï¸ ×¢×¨×•×š';

            editBtn.onclick = () => openEditEquipment(eq.id);

 

            const delBtn = document.createElement('button');

            delBtn.className = 'action-btn btn-delete';

            delBtn.textContent = 'ğŸ—‘ï¸ ××—×§';

            delBtn.onclick = () => deleteEquipment(eq.id);

 

            actions.appendChild(editBtn);

            actions.appendChild(delBtn);

            header.appendChild(actions);

            card.appendChild(header);

 

            const visibleChildren = q ? childMatches : (eq.children || []);

            if (visibleChildren && visibleChildren.length) {

                const list = document.createElement('ul');

                visibleChildren.forEach(child => {

                    const li = document.createElement('li');

                    const span = document.createElement('span');

                    span.textContent = child.name;

                    li.appendChild(span);

 

                    const editChild = document.createElement('button');

                    editChild.className = 'action-btn btn-edit';

                    editChild.title = '×¢×¨×•×š';

                    editChild.textContent = 'âœï¸';

                    editChild.onclick = () => openEditEquipment(eq.id, child.id);

 

                    const delChild = document.createElement('button');

                    delChild.className = 'action-btn btn-delete';

                    delChild.title = '××—×§';

                    delChild.textContent = 'ğŸ—‘ï¸';

                    delChild.onclick = () => deleteEquipment(eq.id, child.id);

 

                    li.appendChild(editChild);

                    li.appendChild(delChild);

                    list.appendChild(li);

                });

                card.appendChild(list);

            }

 

            grid.appendChild(card);

        });

    }

 

    function updateEquipmentSelect() {

        const select = document.getElementById('equipment');

        select.innerHTML = '<option value="">-- ×‘×—×¨ ×¦×™×•×“ --</option>';

        equipment.forEach(eq => {

            const optgroup = document.createElement('optgroup');

            optgroup.label = eq.name;

 

            const optParent = document.createElement('option');

            optParent.value = String(eq.id);

            optParent.textContent = eq.name;

            optgroup.appendChild(optParent);

 

            (eq.children || []).forEach(child => {

                const opt = document.createElement('option');

                opt.value = String(child.id);

                opt.textContent = `  â†³ ${child.name}`;

                optgroup.appendChild(opt);

            });

 

            select.appendChild(optgroup);

        });

 

        // ×’× ×˜×•×¤×¡ ×¦×™×•×“ ××‘ ×œ× ×™×”×•×œ (× ×¨×¤×¨×© ×‘×¢×ª ×¤×ª×™×—×ª/×¢×¨×™×›×ª ×¦×™×•×“)

        refreshParentSelectOptions();

    }

 

    function getEquipmentLabel(id) {

        for (let eq of equipment) {

            if (eq.id === id) return eq.name;

            const child = (eq.children || []).find(c => c.id === id);

            if (child) return `${eq.name} > ${child.name}`;

        }

        return '';

    }

 

    // ===== Faults: Add, Filter, Edit, Export =====

    async function submitFault() {

        const eqId = parseInt(document.getElementById('equipment').value);

        const reporterName = document.getElementById('reporterName').value.trim();

        const technician = document.getElementById('technician').value.trim();

        const faultTime = document.getElementById('faultTime').value;

        const description = document.getElementById('description').value.trim();

        const files = document.getElementById('faultImages').files;

 

        if (!eqId || !reporterName || !technician) {

            alert('××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”!');

            return;

        }

 

        // ×ª××•× ×•×ª: ××’×‘×œ×•×ª

        let images = [];

        if (files && files.length) {

            if (files.length > MAX_IMAGES) {

                alert(`× ×™×ª×Ÿ ×œ×¦×¨×£ ×¢×“ ${MAX_IMAGES} ×ª××•× ×•×ª.`);

            } else {

                const totalBytes = Array.from(files).reduce((sum, f) => sum + f.size, 0);

                if (totalBytes > MAX_IMAGES_TOTAL_BYTES) {

                    alert('×¡×š ×’×•×“×œ ×”×§×‘×¦×™× ×’×“×•×œ ××“×™ (××¢×œ 1.5MB). ×”×“×™×•×•×— ×™×™×©××¨ ×œ×œ× ×ª××•× ×•×ª.');

                } else {

                    // ×§×¨×™××ª Base64 (Data URL)

                    images = await Promise.all(Array.from(files).map(file => fileToDataURL(file)));

                }

            }

        }

 

        faults.push({

            id: nextId++,

            equipment: eqId,

            equipmentLabel: getEquipmentLabel(eqId),

            reporterName,

            technician,

            faultTime,

            description,

            images, // dataURL[]

            createdAt: new Date().toLocaleString('he-IL')

        });

 

        // × ×™×§×•×™ ×˜×•×¤×¡

        document.getElementById('equipment').value = '';

        document.getElementById('reporterName').value = '';

        document.getElementById('technician').value = '';

        document.getElementById('description').value = '';

        document.getElementById('faultImages').value = '';

        setDefaultDateTime();

 

        saveState();

        renderFaults();

    }

 

    function fileToDataURL(file) {

        return new Promise((resolve, reject) => {

            const fr = new FileReader();

            fr.onload = () => resolve(fr.result);

            fr.onerror = reject;

            fr.readAsDataURL(file);

        });

    }

 

    function getFilteredFaults() {

        const q = document.getElementById('faultSearch').value.trim().toLowerCase();

        const from = document.getElementById('faultFrom').value ? new Date(document.getElementById('faultFrom').value) : null;

        const to = document.getElementById('faultTo').value ? new Date(document.getElementById('faultTo').value + 'T23:59:59') : null;

 

        return faults.filter(f => {

            // ×˜×•×•×— ×ª××¨×™×›×™× ×œ×¤×™ faultTime ×× ×§×™×™×, ××—×¨×ª ×œ×¤×™ createdAt

            let refTime = null;

            if (f.faultTime) {

                const dt = new Date(f.faultTime);

                if (!isNaN(dt)) refTime = dt;

            }

            if (!refTime && f.createdAt) {

                const dt2 = new Date(f.createdAt);

                if (!isNaN(dt2)) refTime = dt2;

            }

 

            if (from && refTime && refTime < from) return false;

            if (to && refTime && refTime > to) return false;

 

            if (!q) return true;

            const hay = [

                f.equipmentLabel || '',

                f.reporterName || '',

                f.technician || '',

                f.description || ''

            ].join(' ').toLowerCase();

            return hay.includes(q);

        });

    }

 

    function clearFaultFilters() {

        document.getElementById('faultSearch').value = '';

        document.getElementById('faultFrom').value = '';

        document.getElementById('faultTo').value = '';

        renderFaults();

    }

 

    function exportFaultsCsv() {

        const rows = getFilteredFaults();

        const headers = ['ID','×¦×™×•×“','××“×•×•×—','×˜×›× ××™','×–××Ÿ ×ª×§×œ×”','×ª×™××•×¨','× ×•×¦×¨ ×‘×ª××¨×™×š','××¡×³ ×ª××•× ×•×ª'];

        const csvLines = [];

        csvLines.push(headers.map(toCsvValue).join(','));

 

        rows.forEach(f => {

            csvLines.push([

                toCsvValue(f.id),

                toCsvValue(f.equipmentLabel),

                toCsvValue(f.reporterName),

                toCsvValue(f.technician),

                toCsvValue(f.faultTime ? new Date(f.faultTime).toLocaleString('he-IL') : ''),

                toCsvValue(f.description || ''),

                toCsvValue(f.createdAt || ''),

                toCsvValue((f.images && f.images.length) ? f.images.length : 0)

            ].join(','));

        });

 

        // ×”×•×¡×¤×ª BOM ×›×“×™ ×©Ö¾Excel ×™×–×”×” UTFâ€‘8 ×‘×¢×‘×¨×™×ª

        const csvContent = '\uFEFF' + csvLines.join('\r\n');

        const filename = `faults_${formatDateCompact(new Date())}.csv`;

        downloadBlob(csvContent, filename, 'text/csv;charset=utf-8;');

    }

 

    function formatWhatsAppMessage(fault) {

        const imagesNote = (fault.images && fault.images.length)

            ? `ğŸ“ *×§×‘×¦×™× ××¦×•×¨×¤×™×*: ${fault.images.length} ×ª××•× ×”/×•×ª (×–××™× ×•×ª ×‘××¢×¨×›×ª)\n`

            : '';

        return `ğŸ“‹ *×“×™×•×•×— ×ª×§×œ×”*\n\n` +

               `ğŸ­ *×¦×™×•×“*: ${fault.equipmentLabel}\n` +

               `ğŸ“ *×“×™×•×•×— ×¢×œ ×™×“×™*: ${fault.reporterName}\n` +

               `ğŸ”§ *×˜×›× ××™*: ${fault.technician}\n` +

               `â° *×–××Ÿ ×”×ª×§×œ×”*: ${fault.faultTime ? new Date(fault.faultTime).toLocaleString('he-IL') : ''}\n` +

               `ğŸ“ *×ª×™××•×¨*: ${fault.description || '×œ×œ× ×ª×™××•×¨ × ×•×¡×£'}\n` +

               imagesNote +

               `ğŸ“… *×¨×™×©×•×*: ${fault.createdAt}`;

    }

 

    function sendToWhatsApp(faultId) {

        const fault = faults.find(f => f.id === faultId);

        if (!fault) return;

 

        const message = formatWhatsAppMessage(fault);

        const encoded = encodeURIComponent(message);

        window.open(`https://wa.me/?text=${encoded}`, '_blank');

    }

 

    function copyToClipboard(faultId) {

        const fault = faults.find(f => f.id === faultId);

        if (!fault) return;

 

        const message = formatWhatsAppMessage(fault);

        if (navigator.clipboard?.writeText) {

            navigator.clipboard.writeText(message).then(() => {

                alert('âœ“ ×”×•×“×¢×” ×”×•×¢×ª×§×”!');

            }).catch(() => fallbackCopy(message));

        } else {

            fallbackCopy(message);

        }

 

        function fallbackCopy(text) {

            const ta = document.createElement('textarea');

            ta.value = text;

            document.body.appendChild(ta);

            ta.select();

            try {

                document.execCommand('copy');

                alert('âœ“ ×”×•×“×¢×” ×”×•×¢×ª×§×”!');

            } catch {

                alert('×©×’×™××” ×‘×”×¢×ª×§×”');

            } finally {

                document.body.removeChild(ta);

            }

        }

    }

 

    function deleteFault(id) {

        if (confirm('×”×× ××ª×” ×‘×˜×•×—?')) {

            faults = faults.filter(f => f.id !== id);

            saveState();

            renderFaults();

        }

    }

 

    function toggleEditFault(id) {

        const el = document.getElementById('edit_fault_' + id);

        if (el) el.classList.toggle('hidden');

    }

 

    function saveEditFault(id) {

        const f = faults.find(x => x.id === id);

        if (!f) return;

 

        const eqSelect = document.getElementById('edit_eq_' + id);

        const reporter = document.getElementById('edit_reporter_' + id).value.trim();

        const tech = document.getElementById('edit_tech_' + id).value.trim();

        const time = document.getElementById('edit_time_' + id).value;

        const desc = document.getElementById('edit_desc_' + id).value.trim();

 

        if (!eqSelect.value || !reporter || !tech) {

            alert('××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”!');

            return;

        }

        f.equipment = parseInt(eqSelect.value, 10);

        f.equipmentLabel = getEquipmentLabel(f.equipment);

        f.reporterName = reporter;

        f.technician = tech;

        f.faultTime = time;

        f.description = desc;

 

        saveState();

        renderFaults();

    }

 

    function cancelEditFault(id) {

        const el = document.getElementById('edit_fault_' + id);

        if (el) el.classList.add('hidden');

    }

 

    function renderFaults() {

        const container = document.getElementById('faultsList');

        const filtered = getFilteredFaults();

        document.getElementById('faultCount').textContent = `${filtered.length} / ${faults.length}`;

 

        if (filtered.length === 0) {

            container.innerHTML = '<div class="empty-message">××™×Ÿ ×“×™×•×•×—×™× ×©×¢×•× ×™× ×¢×œ ×”×¡×™× ×•×Ÿ</div>';

            return;

        }

 

        container.innerHTML = filtered.map(fault => {

            const imgs = (fault.images && fault.images.length)

                ? `<div class="thumbs">

                        ${fault.images.map((src, idx) => `${src}${src}</a>`).join('')}

                   </div>`

                : '';

 

            const equipmentOptionsHtml = getEquipmentOptionsHtml(fault.equipment);

 

            return `

                <div class="fault-item">

                    <div class="fault-grid">

                        <div class="fault-field">

                            <strong>×¦×™×•×“:</strong>

                            <p>${escapeHtml(fault.equipmentLabel)}</p>

                        </div>

                        <div class="fault-field">

                            <strong>×“×™×•×•×—:</strong>

                            <p>${escapeHtml(fault.reporterName)}</p>

                        </div>

                        <div class="fault-field">

                            <strong>×˜×›× ××™:</strong>

                            <p>${escapeHtml(fault.technician)}</p>

                        </div>

                        <div class="fault-field">

                            <strong>×–××Ÿ:</strong>

                            <p>${fault.faultTime ? new Date(fault.faultTime).toLocaleString('he-IL') : ''}</p>

                        </div>

                    </div>

                    ${fault.description ? `<div class="fault-description"><strong>×ª×™××•×¨:</strong> ${escapeHtml(fault.description)}</div>` : ''}

                    ${imgs}

                    <div class="fault-buttons">

                        <button class="btn-edit-fault" onclick="toggleEditFault(${fault.id})">âœï¸ ×¢×¨×•×š</button>

                        <button class="btn-rsl" onclick="sendToWhatsApp(${fault.id})">ğŸ“± ×©×œ×— ×œâ€‘RSL</button>

                        <button class="btn-whatsapp" onclick="sendToWhatsApp(${fault.id})">ğŸ’¬ ×©×œ×— ×œâ€‘WhatsApp</button>

                        <button class="btn-copy" onclick="copyToClipboard(${fault.id})">ğŸ“‹ ×”×¢×ª×§</button>

                        <button class="btn-delete" onclick="deleteFault(${fault.id})">ğŸ—‘ï¸ ××—×§</button>

                    </div>

 

                    <div id="edit_fault_${fault.id}" class="edit-fault hidden">

                        <div class="form-grid">

                            <div class="form-group">

                                <label>×¦×™×•×“ *</label>

                                <select id="edit_eq_${fault.id}" class="select">

                                    ${equipmentOptionsHtml}

                                </select>

                            </div>

                            <div class="form-group">

                                <label>×©× ×”××“×•×•×— *</label>

                                <input id="edit_reporter_${fault.id}" class="input" type="text" value="${escapeHtml(fault.reporterName)}">

                            </div>

                            <div class="form-group">

                                <label>×˜×›× ××™/×’×•×¨× ××‘×¦×¢ *</label>

                                <input id="edit_tech_${fault.id}" class="input" type="text" value="${escapeHtml(fault.technician)}">

                            </div>

                            <div class="form-group">

                                <label>×–××Ÿ ×”×ª×§×œ×”</label>

                                <input id="edit_time_${fault.id}" class="input" type="datetime-local" value="${fault.faultTime ? new Date(fault.faultTime).toISOString().slice(0,16) : ''}">

                            </div>

                            <div class="form-group form-grid-full">

                                <label>×ª×™××•×¨</label>

                                <textarea id="edit_desc_${fault.id}" class="input" rows="3">${escapeHtml(fault.description || '')}</textarea>

                            </div>

                        </div>

                        <div class="toolbar">

                            <button class="btn btn-ok" onclick="saveEditFault(${fault.id})">ğŸ’¾ ×©××•×¨</button>

                            <button class="btn btn-cancel" onclick="cancelEditFault(${fault.id})">×‘×˜×œ</button>

                        </div>

                        <div class="hint" style="color:#6b7280">×”×¢×¨×”: ×ª××•× ×•×ª ××™× ×Ÿ × ×¢×¨×›×•×ª ×›××Ÿ. × ×™×ª×Ÿ ×œ××—×•×§ ×•×œ×™×¦×•×¨ ×“×™×•×•×— ×—×“×© ×× ×“×¨×•×© ×©×™× ×•×™ ×‘×§×‘×¦×™×.</div>

                    </div>

                </div>

            `;

        }).join('');

    }

 

    function getEquipmentOptionsHtml(selectedId) {

        let html = '';

        equipment.forEach(eq => {

            html += `<optgroup label="${escapeHtml(eq.name)}">`;

            const selP = (selectedId === eq.id) ? 'selected' : '';

            html += `<option value="${eq.id}" ${selP}>${escapeHtml(eq.name)}</option>`;

            (eq.children || []).forEach(child => {

                const selC = (selectedId === child.id) ? 'selected' : '';

                html += `<option value="${child.id}" ${selC}>â†³ ${escapeHtml(child.name)}</option>`;

            });

            html += `</optgroup>`;

        });

        return html;

    }

</script>

</body>

</html>


 

 
