<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×“×™×•×•×— ×ª×§×œ×•×ª - RSL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom right, #f0fdf4, #f0f9ff);
            padding: 20px; min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 32px; color: #1f2937; margin-bottom: 10px; }
        .header p { color: #6b7280; font-size: 16px; }
        .section {
            background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 25px; margin-bottom: 20px;
        }
        .section h2 {
            font-size: 24px; color: #1f2937; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 3px solid #8b5cf6;
        }
        .equipment-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px; margin-bottom: 15px;
        }
        .equipment-card {
            background: #faf5ff; border: 2px solid #d8b4fe; border-radius: 8px; padding: 15px;
        }
        .equipment-card-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .equipment-card ul { list-style: none; padding-right: 18px; }
        .equipment-card li { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 15px;
        }
        .form-grid-full { grid-column: 1 / -1; }
        .btn-save {
            background: #22c55e; color: white; border: none; padding: 12px 20px;
            border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px;
        }
        .btn-save:hover { background: #16a34a; }
        .equipment-form {
            background: #faf5ff; padding: 15px; border-radius: 6px; border: 2px solid #d8b4fe;
            margin-top: 10px; max-width: 520px;
        }
        .equipment-form .hint { color: #6b7280; font-size: 12px; margin-top: -6px; margin-bottom: 8px; }
        .mode-badge {
            display:inline-block; background:#f59e0b; color:#fff; font-weight:700; font-size:12px;
            padding:2px 8px; border-radius:999px; margin-bottom:8px;
        }
        .btn-primary {
            background: #a855f7; color: white; border: none; padding: 10px 15px;
            border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 15px;
        }
        .btn-primary:hover { background: #9333ea; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 14px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px;
            font-family: inherit; font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: #22c55e;
        }
        .form-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .form-buttons button {
            flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
        }
        .btn-ok { background: #22c55e; color: white; }
        .btn-ok:hover { background: #16a34a; }
        .btn-cancel { background: #6b7280; color: white; }
        .btn-cancel:hover { background: #4b5563; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-edit:hover { background: #d97706; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .fault-item {
            border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fafafa;
        }
        .fault-item:hover { border-color: #22c55e; }
        .fault-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px; margin-bottom: 10px;
        }
        .fault-field { margin-bottom: 10px; }
        .fault-field strong { color: #1f2937; }
        .fault-field p { color: #4b5563; margin-top: 3px; }
        .fault-description {
            background: #f3f4f6; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px;
        }
        .fault-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .fault-buttons button {
            flex: 1; min-width: 120px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;
        }
        .btn-rsl { background: #059669; color: white; }
        .btn-rsl:hover { background: #047857; }
        .btn-whatsapp { background: #22c55e; color: white; }
        .btn-whatsapp:hover { background: #16a34a; }
        .btn-copy { background: #3b82f6; color: white; }
        .btn-copy:hover { background: #2563eb; }
        .empty-message { text-align: center; padding: 40px; color: #9ca3af; font-size: 16px; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸ“± ×“×™×•×•×— ×ª×§×œ×•×ª</h1>
        <p>××¢×¨×›×ª ×“×™×•×•×— ×ª×§×œ×•×ª ×œ-WhatsApp ×¢× × ×™×”×•×œ ×¦×™×•×“</p>
    </div>

    <!-- Equipment Management -->
    <div class="section">
        <h2>âš™ï¸ × ×™×”×•×œ ×¦×™×•×“</h2>
        <div class="equipment-grid" id="equipmentGrid"></div>
        <button class="btn-primary" onclick="openCreateEquipmentForm()">â• ×”×•×¡×£ ×¦×™×•×“</button>

        <div id="equipmentForm" class="equipment-form hidden" aria-live="polite">
            <div id="equipmentFormMode" class="mode-badge hidden">××¦×‘ ×¢×¨×™×›×”</div>
            <div class="form-group">
                <label>×©× ×”×¦×™×•×“ *</label>
                <input type="text" id="eqName" placeholder="×”×›× ×¡ ×©×">
                <div class="hint">××•××œ×¥ ×©× ×§×¦×¨ ×•×‘×¨×•×¨. ×œ×“×•×’××”: "××›×‘×© ××ª×™×—×” 1"</div>
            </div>
            <div class="form-group">
                <label>×¡×•×’ ×¦×™×•×“</label>
                <select id="eqType" onchange="updateParentOptions()">
                    <option value="parent">×¦×™×•×“ ××‘ (×¢× ×ª×ª-×™×—×™×“×•×ª)</option>
                    <option value="child">×¦×™×•×“ ×‘×Ÿ (×ª×ª-×™×—×™×“×”)</option>
                </select>
                <div class="hint" id="typeHint">×‘×—×¨ ×× ×–×” ×¦×™×•×“ ×¢×¦×××™ ××• ×ª×ª-×™×—×™×“×”</div>
            </div>
            <div class="form-group" id="parentSelect" style="display:none;">
                <label>×©×™×™×š ×œ- *</label>
                <select id="eqParent">
                    <option value="">-- ×‘×—×¨ ×¦×™×•×“ ××‘ --</option>
                </select>
            </div>
            <div class="form-buttons">
                <button id="equipmentFormSubmit" class="btn-ok" onclick="saveEquipment()">×©××•×¨</button>
                <button class="btn-cancel" onclick="closeEquipmentForm()">×‘×˜×œ</button>
            </div>
        </div>
    </div>

    <!-- Report Form -->
    <div class="section">
        <h2>ğŸ“‹ ×˜×•×¤×¡ ×“×™×•×•×— ×ª×§×œ×”</h2>
        <div class="form-grid">
            <div class="form-group">
                <label>×‘×—×¨ ×¦×™×•×“ *</label>
                <select id="equipment">
                    <option value="">-- ×‘×—×¨ ×¦×™×•×“ --</option>
                </select>
            </div>
            <div class="form-group">
                <label>×©× ×”××“×•×•×— *</label>
                <input type="text" id="reporterName" placeholder="×”×›× ×¡ ×©×">
            </div>
            <div class="form-group">
                <label>×˜×›× ××™/×’×•×¨× ××‘×¦×¢ *</label>
                <input type="text" id="technician" placeholder="×”×›× ×¡ ×©×">
            </div>
            <div class="form-group">
                <label>×–××Ÿ ×”×ª×§×œ×”</label>
                <input type="datetime-local" id="faultTime">
            </div>
            <div class="form-group form-grid-full">
                <label>×ª×™××•×¨ ×”×ª×§×œ×”</label>
                <textarea id="description" rows="4" placeholder="×ª××¨ ××ª ×”×ª×§×œ×”..."></textarea>
            </div>
            <div class="form-group form-grid-full">
                <button class="btn-save" onclick="submitFault()">ğŸ’¾ ×©××•×¨ ×“×™×•×•×—</button>
            </div>
        </div>
    </div>

    <!-- Faults History -->
    <div class="section">
        <h2>ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×“×™×•×•×—×™× (<span id="faultCount">0</span>)</h2>
        <div id="faultsList"></div>
    </div>
</div>

<script>
    // ===== Utilities =====
    const STORAGE_KEY = 'fr_rsl_state_v1';

    // Escape user-input to avoid XSS when injecting via innerHTML
    function escapeHtml(str = '') {
        return String(str).replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    // ===== Default data =====
    const defaultEquipment = [
        { id: 1, name: '×¡×§××¤ ×ª×¨××™×œ', isParent: true, children: [
                { id: 11, name: '××›×‘×© ××ª×™×—×” 1' },
                { id: 12, name: '××›×‘×© ××ª×™×—×” 2' },
                { id: 13, name: '××¢×¨×›×ª ×§×™×¨×•×¨' }
        ]},
        { id: 2, name: '×§×• ×™×™×¦×•×¨ B', isParent: true, children: [
                { id: 21, name: '×× ×•×¢ ×—×©××œ×™×ª' },
                { id: 22, name: '×“×•×¨ ××•×•×™×¨ ×“×—×•×¡' }
        ]},
        { id: 3, name: '××›×•× ×ª ×”×“×¤×¡×”', isParent: false, children: [] }
    ];

    // ===== State =====
    let equipment = [];
    let faults = [];
    let nextId = 100;

    // Equipment form state
    let eqFormMode = 'create'; // 'create' | 'edit'
    let editContext = null;    // { target: 'parent' | 'child', parentId, childId? }

    function saveState() {
        const state = { equipment, faults, nextId };
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
            console.warn('×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ×œ-localStorage', e);
        }
    }

    function loadState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                equipment = parsed.equipment || defaultEquipment.slice();
                faults = parsed.faults || [];
                nextId = typeof parsed.nextId === 'number' ? parsed.nextId : 100;
                return;
            }
        } catch (e) {
            console.warn('×©×’×™××” ×‘×˜×¢×™× ×ª ××¦×‘ ××”-localStorage', e);
        }
        equipment = defaultEquipment.slice();
        faults = [];
        nextId = 100;
    }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        setDefaultDateTime();
        renderEquipment();
        renderFaults();
        updateEquipmentSelect();
    });

    function setDefaultDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('faultTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // ===== Equipment Form Logic =====
    function openCreateEquipmentForm() {
        eqFormMode = 'create';
        editContext = null;
        const form = document.getElementById('equipmentForm');
        form.classList.remove('hidden');

        document.getElementById('equipmentFormMode').classList.add('hidden');
        document.getElementById('equipmentFormSubmit').textContent = '×©××•×¨';

        document.getElementById('eqName').value = '';
        document.getElementById('eqType').disabled = false;
        document.getElementById('eqType').value = 'parent';
        document.getElementById('typeHint').textContent = '×‘×—×¨ ×× ×–×” ×¦×™×•×“ ×¢×¦×××™ ××• ×ª×ª-×™×—×™×“×”';
        document.getElementById('parentSelect').style.display = 'none';

        refreshParentSelectOptions();
        document.getElementById('eqName').focus();
    }

    function openEditEquipment(parentId, childId) {
        eqFormMode = 'edit';
        const form = document.getElementById('equipmentForm');
        form.classList.remove('hidden');
        document.getElementById('equipmentFormMode').classList.remove('hidden');
        document.getElementById('equipmentFormMode').textContent = '××¦×‘ ×¢×¨×™×›×”';
        document.getElementById('equipmentFormSubmit').textContent = '×¢×“×›×Ÿ';

        refreshParentSelectOptions();

        if (childId == null) {
            // Edit parent
            const parent = equipment.find(e => e.id === parentId);
            if (!parent) return;

            editContext = { target: 'parent', parentId };
            document.getElementById('eqName').value = parent.name;
            document.getElementById('eqType').value = 'parent';
            document.getElementById('eqType').disabled = true; // ×œ× ××©× ×™× ×¡×•×’ ×©×œ ××‘
            document.getElementById('parentSelect').style.display = 'none';
            document.getElementById('typeHint').textContent = '×¢×¨×™×›×ª ×©× ×¦×™×•×“ ××‘';
        } else {
            // Edit child
            const parent = equipment.find(e => e.id === parentId);
            if (!parent) return;
            const child = parent.children.find(c => c.id === childId);
            if (!child) return;

            editContext = { target: 'child', parentId, childId };
            document.getElementById('eqName').value = child.name;
            document.getElementById('eqType').value = 'child';
            document.getElementById('eqType').disabled = true; // ×œ× ××©× ×™× ×¡×•×’ ×©×œ ×‘×Ÿ
            document.getElementById('parentSelect').style.display = 'block';
            document.getElementById('eqParent').value = String(parentId);
            document.getElementById('typeHint').textContent = '×¢×¨×™×›×ª ×©×/×©×™×•×š ×¦×™×•×“ ×‘×Ÿ';
        }
        document.getElementById('eqName').focus();
    }

    function closeEquipmentForm() {
        const form = document.getElementById('equipmentForm');
        form.classList.add('hidden');
        eqFormMode = 'create';
        editContext = null;
    }

    function updateParentOptions() {
        const type = document.getElementById('eqType').value;
        document.getElementById('parentSelect').style.display = type === 'child' ? 'block' : 'none';
    }

    function refreshParentSelectOptions() {
        const parentSelect = document.getElementById('eqParent');
        parentSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¦×™×•×“ ××‘ --</option>';
        equipment.filter(e => e.isParent).forEach(eq => {
            const opt = document.createElement('option');
            opt.value = String(eq.id);
            opt.textContent = eq.name;
            parentSelect.appendChild(opt);
        });
    }

    function saveEquipment() {
        const name = document.getElementById('eqName').value.trim();
        const type = document.getElementById('eqType').value;
        const parentIdStr = document.getElementById('eqParent').value;
        const parentId = parentIdStr ? parseInt(parentIdStr, 10) : null;

        if (!name) {
            alert('×”×›× ×¡ ×©× ×¦×™×•×“!');
            return;
        }

        if (eqFormMode === 'edit' && editContext) {
            if (editContext.target === 'parent') {
                const parent = equipment.find(e => e.id === editContext.parentId);
                if (!parent) return;
                parent.name = name;
            } else if (editContext.target === 'child') {
                const oldParent = equipment.find(e => e.id === editContext.parentId);
                if (!oldParent) return;
                const child = oldParent.children.find(c => c.id === editContext.childId);
                if (!child) return;

                if (!parentId) {
                    alert('×‘×—×¨ ×¦×™×•×“ ××‘!');
                    return;
                }
                // ×¢×“×›×•×Ÿ ×©×
                child.name = name;

                // ×× ×©×™× ×• ×”×•×¨×” â€“ ××¢×‘×™×¨×™× ××ª ×”×¦×™×•×“ ×‘×Ÿ ×œ×”×•×¨×” ×—×“×©
                if (parentId !== editContext.parentId) {
                    // ×”×¡×¨×” ××”×”×•×¨×” ×”×§×•×“×
                    oldParent.children = oldParent.children.filter(c => c.id !== child.id);
                    // ×”×•×¡×¤×” ×œ×”×•×¨×” ×”×—×“×©
                    const newParent = equipment.find(e => e.id === parentId);
                    if (!newParent) {
                        alert('×¦×™×•×“ ×”××‘ ×©× ×‘×—×¨ ×œ× ×§×™×™×');
                        return;
                    }
                    newParent.children.push(child);
                    // ×¢×“×›×•×Ÿ ×”×§×©×¨ ×œ×¢×¨×™×›×”
                    editContext.parentId = newParent.id;
                }
            }

            saveState();
            renderEquipment();
            updateEquipmentSelect();
            closeEquipmentForm();
            return;
        }

        // create mode
        if (type === 'child') {
            if (!parentId) {
                alert('×‘×—×¨ ×¦×™×•×“ ××‘!');
                return;
            }
            const parent = equipment.find(e => e.id === parentId);
            if (parent) {
                parent.children.push({ id: nextId++, name: name });
            }
        } else {
            equipment.push({ id: nextId++, name: name, isParent: true, children: [] });
        }

        saveState();
        renderEquipment();
        updateEquipmentSelect();
        closeEquipmentForm();
    }

    function deleteEquipment(parentId, childId) {
        if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§?')) return;

        if (childId) {
            const parent = equipment.find(e => e.id === parentId);
            if (parent) {
                parent.children = parent.children.filter(c => c.id !== childId);
            }
        } else {
            equipment = equipment.filter(e => e.id !== parentId);
        }
        saveState();
        renderEquipment();
        updateEquipmentSelect();
    }

    function renderEquipment() {
        const grid = document.getElementById('equipmentGrid');
        grid.innerHTML = '';

        equipment.forEach(eq => {
            const card = document.createElement('div');
            card.className = 'equipment-card';

            const header = document.createElement('div');
            header.className = 'equipment-card-header';

            const title = document.createElement('strong');
            title.textContent = eq.name;
            header.appendChild(title);

            const actions = document.createElement('div');
            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn btn-edit';
            editBtn.textContent = 'âœï¸ ×¢×¨×•×š';
            editBtn.onclick = () => openEditEquipment(eq.id);

            const delBtn = document.createElement('button');
            delBtn.className = 'action-btn btn-delete';
            delBtn.textContent = 'ğŸ—‘ï¸ ××—×§';
            delBtn.onclick = () => deleteEquipment(eq.id);

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);
            header.appendChild(actions);

            card.appendChild(header);

            if (eq.children && eq.children.length) {
                const list = document.createElement('ul');
                eq.children.forEach(child => {
                    const li = document.createElement('li');
                    const span = document.createElement('span');
                    span.textContent = child.name;
                    li.appendChild(span);

                    const editChild = document.createElement('button');
                    editChild.className = 'action-btn btn-edit';
                    editChild.title = '×¢×¨×•×š';
                    editChild.textContent = 'âœï¸';
                    editChild.onclick = () => openEditEquipment(eq.id, child.id);

                    const delChild = document.createElement('button');
                    delChild.className = 'action-btn btn-delete';
                    delChild.title = '××—×§';
                    delChild.textContent = 'ğŸ—‘ï¸';
                    delChild.onclick = () => deleteEquipment(eq.id, child.id);

                    li.appendChild(editChild);
                    li.appendChild(delChild);
                    list.appendChild(li);
                });
                card.appendChild(list);
            }

            grid.appendChild(card);
        });
    }

    function updateEquipmentSelect() {
        const select = document.getElementById('equipment');
        const parentSelect = document.getElementById('eqParent');

        // ×¦×™×•×“ ×œ×“×™×•×•×— ×ª×§×œ×•×ª
        select.innerHTML = '<option value="">-- ×‘×—×¨ ×¦×™×•×“ --</option>';
        equipment.forEach(eq => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = eq.name;

            const optParent = document.createElement('option');
            optParent.value = String(eq.id);
            optParent.textContent = eq.name;
            optgroup.appendChild(optParent);

            (eq.children || []).forEach(child => {
                const opt = document.createElement('option');
                opt.value = String(child.id);
                opt.textContent = `  â†³ ${child.name}`;
                optgroup.appendChild(opt);
            });

            select.appendChild(optgroup);
        });

        // ×¦×™×•×“ ××‘ ×œ×‘×—×™×¨×” ×‘×˜×•×¤×¡ (××˜×•×¤×œ ×’× ×‘-refreshParentSelectOptions)
        refreshParentSelectOptions();
    }

    function getEquipmentLabel(id) {
        for (let eq of equipment) {
            if (eq.id === id) return eq.name;
            const child = (eq.children || []).find(c => c.id === id);
            if (child) return `${eq.name} > ${child.name}`;
        }
        return '';
    }

    // ===== Faults Logic =====
    function submitFault() {
        const eqId = parseInt(document.getElementById('equipment').value);
        const reporterName = document.getElementById('reporterName').value.trim();
        const technician = document.getElementById('technician').value.trim();
        const faultTime = document.getElementById('faultTime').value;
        const description = document.getElementById('description').value.trim();

        if (!eqId || !reporterName || !technician) {
            alert('××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”!');
            return;
        }

        faults.push({
            id: nextId++,
            equipment: eqId,
            equipmentLabel: getEquipmentLabel(eqId),
            reporterName: reporterName,
            technician: technician,
            faultTime: faultTime,
            description: description,
            createdAt: new Date().toLocaleString('he-IL')
        });

        document.getElementById('equipment').value = '';
        document.getElementById('reporterName').value = '';
        document.getElementById('technician').value = '';
        document.getElementById('description').value = '';
        setDefaultDateTime();

        saveState();
        renderFaults();
    }

    function formatWhatsAppMessage(fault) {
        return `ğŸ“‹ *×“×™×•×•×— ×ª×§×œ×”*\n\n` +
               `ğŸ­ *×¦×™×•×“*: ${fault.equipmentLabel}\n` +
               `ğŸ“ *×“×™×•×•×— ×¢×œ ×™×“×™*: ${fault.reporterName}\n` +
               `ğŸ”§ *×˜×›× ××™*: ${fault.technician}\n` +
               `â° *×–××Ÿ ×”×ª×§×œ×”*: ${new Date(fault.faultTime).toLocaleString('he-IL')}\n` +
               `ğŸ“ *×ª×™××•×¨*: ${fault.description || '×œ×œ× ×ª×™××•×¨ × ×•×¡×£'}\n` +
               `ğŸ“… *×¨×™×©×•×*: ${fault.createdAt}`;
    }

    function sendToWhatsApp(faultId) {
        const fault = faults.find(f => f.id === faultId);
        if (!fault) return;

        const message = formatWhatsAppMessage(fault);
        const encoded = encodeURIComponent(message);
        // ×›×“×™ ×œ×©×œ×•×— ×œ××¡×¤×¨ ××¡×•×™×: ×”×—×œ×£ ×œ- https://wa.me/<PHONE>?text=...
        window.open(`https://wa.me/?text=${encoded}`, '_blank');
    }

    function copyToClipboard(faultId) {
        const fault = faults.find(f => f.id === faultId);
        if (!fault) return;

        const message = formatWhatsAppMessage(fault);

        if (navigator.clipboard?.writeText) {
            navigator.clipboard.writeText(message).then(() => {
                alert('âœ“ ×”×•×“×¢×” ×”×•×¢×ª×§×”!');
            }).catch(() => {
                fallbackCopy(message);
            });
        } else {
            fallbackCopy(message);
        }

        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                alert('âœ“ ×”×•×“×¢×” ×”×•×¢×ª×§×”!');
            } catch {
                alert('×©×’×™××” ×‘×”×¢×ª×§×”');
            } finally {
                document.body.removeChild(ta);
            }
        }
    }

    function deleteFault(id) {
        if (confirm('×”×× ××ª×” ×‘×˜×•×—?')) {
            faults = faults.filter(f => f.id !== id);
            saveState();
            renderFaults();
        }
    }

    function renderFaults() {
        const container = document.getElementById('faultsList');
        document.getElementById('faultCount').textContent = faults.length;

        if (faults.length === 0) {
            container.innerHTML = '<div class="empty-message">××™×Ÿ ×“×™×•×•×—×™× ×¢×“×™×™×Ÿ</div>';
            return;
        }

        container.innerHTML = faults.map(fault => `
            <div class="fault-item">
                <div class="fault-grid">
                    <div class="fault-field">
                        <strong>×¦×™×•×“:</strong>
                        <p>${escapeHtml(fault.equipmentLabel)}</p>
                    </div>
                    <div class="fault-field">
                        <strong>×“×™×•×•×—:</strong>
                        <p>${escapeHtml(fault.reporterName)}</p>
                    </div>
                    <div class="fault-field">
                        <strong>×˜×›× ××™:</strong>
                        <p>${escapeHtml(fault.technician)}</p>
                    </div>
                    <div class="fault-field">
                        <strong>×–××Ÿ:</strong>
                        <p>${new Date(fault.faultTime).toLocaleString('he-IL')}</p>
                    </div>
                </div>
                ${fault.description ? `<div class="fault-description"><strong>×ª×™××•×¨:</strong> ${escapeHtml(fault.description)}</div>` : ''}
                <div class="fault-buttons">
                    <button class="btn-rsl" onclick="sendToWhatsApp(${fault.id})">ğŸ“± ×©×œ×— ×œ-RSL</button>
                    <button class="btn-whatsapp" onclick="sendToWhatsApp(${fault.id})">ğŸ’¬ ×©×œ×— ×œ-WhatsApp</button>
                    <button class="btn-copy" onclick="copyToClipboard(${fault.id})">ğŸ“‹ ×”×¢×ª×§</button>
                    <button class="btn-delete" onclick="deleteFault(${fault.id})">ğŸ—‘ï¸ ××—×§</button>
                </div>
            </div>
        `).join('');
    }
</script>
</body>
</html>
